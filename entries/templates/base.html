<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Diary App{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="My Diary">
    <meta name="description" content="A personal diary app to capture your thoughts, memories, and daily experiences">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="{% static 'entries/icons/icon-192x192.svg' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'entries/icons/favicon.svg' %}">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="{% static 'entries/icons/favicon.svg' %}">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'entries/manifest.json' %}">
    
    <!-- Bulma CSS Framework -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome for social icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'entries/css/diary.css' %}">
    <link rel="stylesheet" href="{% static 'css/theme-system.css' %}">
    <link rel="stylesheet" href="{% static 'entries/css/components.css' %}">
</head>
<body>
    <div class="container">
        {% include 'include/navbar.html' %}


        <main class="content">
            {% block content %}{% endblock %}
        </main>

        {% include 'include/footer.html' %}
    </div>

        <!-- Install Instructions Modal -->
        <div class="modal" id="install-instructions-modal">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">ðŸ“± How to Install Diary App</p>
                    <button class="delete" aria-label="close" id="close-install-modal"></button>
                </header>
                <section class="modal-card-body" style="font-size:1em;">
                    <ul style="line-height:1.7;">
                        <li><strong>Chrome/Edge:</strong> Click the âŠ• icon in the address bar</li>
                        <li><strong>Firefox:</strong> Bookmark this page for quick access</li>
                        <li><strong>Safari (iOS):</strong> Share â†’ Add to Home Screen</li>
                        <li><strong>Opera:</strong> Menu â†’ Install App</li>
                        <li><strong>Brave:</strong> âŠ• icon or menu</li>
                        <li><strong>Samsung Internet:</strong> Menu â†’ Add to Home Screen</li>
                    </ul>
                </section>
            </div>
        </div>

    <!-- Offline functionality -->
    <script src="{% static 'entries/js/offline.js' %}"></script>
    <script src="{% static 'entries/js/scripts.js' %}"></script>

    <!-- PWA & Connection JS -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Connection status
        const statusIndicator = document.getElementById('connection-status');
        function updateConnectionStatus() {
            if (!statusIndicator) return;
            statusIndicator.innerHTML = navigator.onLine ? 'ðŸŸ¢ Online' : 'ðŸ”´ Offline';
            statusIndicator.style.color = navigator.onLine ? '#28a745' : '#dc3545';
        }
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        updateConnectionStatus();

        // PWA install prompt
        let deferredPrompt;
        const installBtn = document.getElementById('pwa-install-button');
        let isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installBtn && !isStandalone) installBtn.style.display = 'block';
        });

        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const choiceResult = await deferredPrompt.userChoice;
                if (choiceResult.outcome === 'accepted') console.log('User accepted the install prompt');
                deferredPrompt = null;
                installBtn.style.display = 'none';
            });
        }

        window.addEventListener('appinstalled', () => {
            console.log('PWA installed');
            if (installBtn) installBtn.style.display = 'none';
            isStandalone = true;
        });

        // Fallback removed: instructions now in modal

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => {
                    console.log('ServiceWorker registered');
                    setInterval(() => reg.update(), 3600000);
                })
                .catch(err => console.log('ServiceWorker registration failed:', err));
        }
    });
    </script>

    {% block extra_js %}{% endblock %}
</body>
<script>
// Modal logic for install instructions
document.addEventListener('DOMContentLoaded', function() {
    var modal = document.getElementById('install-instructions-modal');
    var link = document.getElementById('install-instructions-link');
    var closeBtn = document.getElementById('close-install-modal');
    if (link && modal && closeBtn) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            modal.classList.add('is-active');
        });
        closeBtn.addEventListener('click', function() {
            modal.classList.remove('is-active');
        });
        modal.querySelector('.modal-background').addEventListener('click', function() {
            modal.classList.remove('is-active');
        });
    }
});
</script>
</html>
