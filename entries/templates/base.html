<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Diary App{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="My Diary">
    <meta name="description" content="A personal diary app to capture your thoughts, memories, and daily experiences">
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="{% static 'entries/icons/icon-192x192.svg' %}">
    <link rel="icon" type="image/svg+xml" href="{% static 'entries/icons/favicon.svg' %}">
    <link rel="icon" type="image/svg+xml" sizes="32x32" href="{% static 'entries/icons/favicon.svg' %}">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'entries/manifest.json' %}">
    
    <!-- Bulma CSS Framework -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'entries/css/diary.css' %}">
    <link rel="stylesheet" href="{% static 'css/theme-system.css' %}">
    <link rel="stylesheet" href="{% static 'entries/css/components.css' %}">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="page-title">{% block page_title %}My Diary{% endblock %}</h1>
            {% include 'include/navbar.html' %}
        </header>

        <main class="content">
            {% block content %}{% endblock %}
        </main>

        {% include 'include/footer.html' %}
    </div>

    <!-- PWA Install Button -->
    <div id="pwa-install-button" style="display:none; position:fixed; bottom:12px; right:12px; z-index:9999; background:#007bff; color:white; padding:8px 12px; border-radius:6px; font-size:14px; cursor:pointer;">
        ðŸ“± Install Diary App
    </div>

    <!-- Offline functionality -->
    <script src="{% static 'entries/js/offline.js' %}"></script>

    <!-- PWA & Connection JS -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Connection status
        const statusIndicator = document.getElementById('connection-status');
        function updateConnectionStatus() {
            if (!statusIndicator) return;
            statusIndicator.innerHTML = navigator.onLine ? 'ðŸŸ¢ Online' : 'ðŸ”´ Offline';
            statusIndicator.style.color = navigator.onLine ? '#28a745' : '#dc3545';
        }
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
        updateConnectionStatus();

        // PWA install prompt
        let deferredPrompt;
        const installBtn = document.getElementById('pwa-install-button');
        let isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installBtn && !isStandalone) installBtn.style.display = 'block';
        });

        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                deferredPrompt.prompt();
                const choiceResult = await deferredPrompt.userChoice;
                if (choiceResult.outcome === 'accepted') console.log('User accepted the install prompt');
                deferredPrompt = null;
                installBtn.style.display = 'none';
            });
        }

        window.addEventListener('appinstalled', () => {
            console.log('PWA installed');
            if (installBtn) installBtn.style.display = 'none';
            isStandalone = true;
        });

        // Fallback for browsers without beforeinstallprompt
        setTimeout(() => {
            if (!deferredPrompt && !isStandalone && installBtn) {
                installBtn.innerHTML = `ðŸ“± Install Diary App<br>
                    <small style="font-weight:normal; font-size:12px; line-height:1.4;">
                        Chrome/Edge: Click âŠ• icon in address bar<br>
                        Firefox: Bookmark this page<br>
                        Safari (iOS): Share â†’ Add to Home Screen<br>
                        Opera: Menu â†’ Install App<br>
                        Brave: âŠ• icon or menu<br>
                        Samsung Internet: Menu â†’ Add to Home Screen
                    </small>`;
                installBtn.style.display = 'block';
                installBtn.style.cursor = 'default';
            }
        }, 2000);

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => {
                    console.log('ServiceWorker registered');
                    setInterval(() => reg.update(), 3600000);
                })
                .catch(err => console.log('ServiceWorker registration failed:', err));
        }
    });
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>
