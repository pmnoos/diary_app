{% extends 'base.html' %}
{% load tz %}

{% block title %}Home - Diary App{% endblock %}

{% block page_title %}
    {% if user.is_authenticated %}
        Welcome to {{ user.username }}'s Diary
    {% else %}
        Welcome to Your Diary
    {% endif %}
{% endblock %}

{% block content %}
    <!-- Reminder Notifications -->
    {% include 'reminders/alerts/notification_banner.html' %}
    
    <!-- Reminder Quick Widget -->
    {% include 'reminders/alerts/quick_widget.html' %}
    
    <!-- PWA Install Banner -->
    <div id="pwa-install-button" class="notification is-primary" style="display: none; margin-bottom: 20px; text-align: center; cursor: pointer;">
        <h4 style="margin: 0 0 10px 0;">ğŸ“± Install Diary App</h4>
        <p style="margin: 0; font-size: 14px;">Get quick access and write offline! Install as an app on your device.</p>
    </div>

    <div class="date-display">
        <h3>Today is {{ current_date|date:"l, F j, Y" }}</h3>
    </div>
    
    <h2>
        {% if user.is_authenticated %}
            Hello, {{ user.username }}!
        {% else %}
            Welcome, Guest!
        {% endif %}
    </h2>

    {% if user.is_authenticated %}
        <div class="box">
            <p>Ready to write your thoughts? Start by creating a new entry or browse your existing ones.</p>
            <p class="buttons" style="margin-top: 10px;">
                <a href="{% url 'entry_create' %}" class="button is-primary">Write New Entry</a>
                <a href="{% url 'entry_list' %}" class="button is-link">View All Entries</a>
                <a href="{% url 'entry_search' %}" class="button is-light">ğŸ” Search Diary</a>
                <a href="{% url 'reminder_list' %}" class="button is-info">ğŸ“… View Reminders</a>
            </p>
        </div>
        
        <!-- Quick Reminder Widget -->
        <div class="box" style="background-color: #f5f5f5;">
            <h4 class="title is-5">ğŸ”” Quick Reminder</h4>
            <p style="color: #6c757d;">Need to remember something? Add a quick reminder for later.</p>
            <div class="buttons" style="margin-top: 10px;">
                <a href="{% url 'reminder_create' %}" class="button is-success">â• Add Reminder</a>
                <a href="{% url 'reminder_list' %}?filter=today" class="button is-warning">Today's Tasks</a>
                <a href="{% url 'reminder_list' %}?filter=this_week" class="button is-info">This Week</a>
            </div>
        </div>
    {% else %}
        <div class="box">
            <p>A personal diary app to capture your thoughts, memories, and daily experiences.</p>
            
            <div class="notification is-info">
                <h3 class="title is-5">ğŸ¯ Try the Demo</h3>
                <p>See what the diary app can do! Browse sample entries to understand the features before creating your account.</p>
                <a href="{% url 'demo_entries' %}" class="button is-success">View Demo Entries</a>
            </div>
            
            <div class="notification is-warning">
                <h3 class="title is-5">ğŸš€ Start Your Own Diary</h3>
                <p>Ready to begin? Create your account and start with a completely fresh, empty diary - just for you!</p>
                <a href="{% url 'signup' %}" class="button is-primary">Create Account</a>
                <a href="{% url 'login' %}" class="button is-light">Login</a>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
    let deferredPrompt;
    let isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

    // Handle beforeinstallprompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBtn = document.getElementById('pwa-install-button');
        if (installBtn && !isStandalone) {
            installBtn.style.display = 'block';
            installBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the PWA install prompt');
                    }
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                });
            });
        }
    });

    // Hide button if installed
    window.addEventListener('appinstalled', () => {
        console.log('PWA installed');
        const installBtn = document.getElementById('pwa-install-button');
        if (installBtn) installBtn.style.display = 'none';
        isStandalone = true;
    });

    // Fallback instructions for browsers without beforeinstallprompt
    window.addEventListener('load', () => {
        setTimeout(() => {
            if (!deferredPrompt && !isStandalone) {
                const installBtn = document.getElementById('pwa-install-button');
                if (installBtn) {
                    installBtn.innerHTML = `
                        ğŸ“± Install Diary App<br>
                        <small style="font-weight:normal; font-size:12px; line-height:1.4;">
                            Chrome/Edge: Click the âŠ• icon in the address bar<br>
                            Firefox: Bookmark this page for quick access<br>
                            Safari (iOS): Tap Share â†’ Add to Home Screen<br>
                            Opera: Use menu â†’ Install App<br>
                            Brave: Click âŠ• icon or use menu<br>
                            Samsung Internet: Menu â†’ Add to Home Screen
                        </small>
                    `;
                    installBtn.style.display = 'block';
                    installBtn.style.cursor = 'default';
                }
            }
        }, 2000);
    });

    // Connection Status Indicator
    function updateConnectionStatus() {
        const statusIndicator = document.getElementById('connection-status');
        if (statusIndicator) {
            if (navigator.onLine) {
                statusIndicator.innerHTML = 'ğŸŸ¢ Online';
                statusIndicator.style.color = '#28a745';
            } else {
                statusIndicator.innerHTML = 'ğŸ”´ Offline';
                statusIndicator.style.color = '#dc3545';
            }
        }
    }

    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);
    document.addEventListener('DOMContentLoaded', updateConnectionStatus);
</script>
{% endblock %}
